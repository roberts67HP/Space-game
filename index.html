<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>My first three.js app</title>
		<style>
			body { margin: 0; }
		</style>
	</head>
	<body>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r126/three.min.js" 
            integrity="sha512-n8IpKWzDnBOcBhRlHirMZOUvEq2bLRMuJGjuVqbzUJwtTsgwOgK5aS0c1JA647XWYfqvXve8k3PtZdzpipFjgg==" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>
        <script src="OrbitControls.js"></script>
		<script>
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0,10,25);
            
            const renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0xFFFFFF);
            renderer.gammaInput = true;
            renderer.gammaOutput = true;
            renderer.shadowMap.enabled = true;
            
            document.body.appendChild(renderer.domElement);
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enabled = false;

            const loader = new THREE.GLTFLoader();
            const clock = new THREE.Clock();

            var ship;
            var asteroids = [];
            var xVel = 0;

            function setupEvents() {
                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }
            function loadShip () {
                loader.load('spaceship/scene.gltf', function (gltf) {
                    ship = gltf.scene.children[0];
                    ship.position.set(0, -20, -5);
                    scene.add(ship);
                }, undefined, function (error) {
                    console.error(error);
                });
            }
            function updateShip () {
                if(ship != null) {
                    // if(ship.position.x < 36 && ship.position.x > -36) {
                        ship.translateX(xVel);
                    // }
                    if(xVel != 0)
                        console.log(ship.position.x);
                }
            }
            function loadSkyBox () {
                var geometry = new THREE.SphereGeometry(500, 32, 32);
                var material = new THREE.MeshStandardMaterial({
                    map: new THREE.TextureLoader().load('2k_stars_milky_way.jpg'),
                    side: THREE.DoubleSide
                });
                skysphere = new THREE.Mesh(geometry, material)
                scene.add(skysphere);

                var sunLight = new THREE.PointLight(0xffffff, 1, 0, 1);
                scene.add(new THREE.AmbientLight(0x404040));
                scene.add(sunLight);

                sunLight.castShadow = true;
                sunLight.shadow.mapSize.width = 1024;
                sunLight.shadow.mapSize.height = 1024;
                sunLight.shadow.camera.near = camera.near;
                sunLight.shadow.camera.far = camera.far;
            }
            function loadAsteroid () {
                var geometry = new THREE.SphereGeometry(1, 15, 15);
                var material = new THREE.MeshStandardMaterial({
                    map: new THREE.TextureLoader().load("2k_moon.jpg"),
                    metalness: 0
                });
                var asteroid = new THREE.Mesh(geometry, material);
                asteroid.castShadow = true;
                asteroid.receiveShadow = true;
                scene.add(asteroid);
                asteroids.push(asteroid);
                asteroid.position.set(0, -2, -130);
            }
            function updateAsteroids (elTime) {
                console.log(elTime);
                if(elTime % 2 == 0) {
                    loadAsteroid();
                }
                asteroids.forEach(function(ast, index, object) {
                    ast.translateZ(2);
                    if(ast.position.z > 10) {
                        scene.remove(ast);
                        object.splice(index, 1);
                    }
                });
            }

            loadShip();
            loadSkyBox();
            setupEvents();

            window.addEventListener('keydown', function (event) {
                let keyCode = event.keyCode;
                switch(keyCode){
                    case 65:
                        xVel = -1;
                        break;
                    case 68:
                        xVel = 1;
                        break;
                }
            }, false);
            window.addEventListener('keyup', function (event) {
                let keyCode = event.keyCode;
                xVel = 0;
            }, false);

            function animate() {
                let elTime = Math.round(clock.getElapsedTime());
                updateAsteroids(elTime);
                updateShip();
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
		</script>
	</body>
</html>